name: Sync Firebase Cache

on:
  push:
    paths:
      - 'documentation.html'
    branches:
      - main

jobs:
  sync-cache:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract and sync content to Firebase
        run: |
          # Extract content between <main> tags
          CONTENT=$(sed -n '/<main[^>]*>/,/<\/main>/p' documentation.html | sed '1s/.*<main[^>]*>//;$s/<\/main>.*//')

          # Escape for JSON
          ESCAPED_CONTENT=$(echo "$CONTENT" | jq -Rs .)

          # Create JSON payload
          JSON_PAYLOAD=$(cat <<EOF
          {
            "content": $ESCAPED_CONTENT,
            "updatedAt": {".sv": "timestamp"},
            "updatedBy": "github-actions"
          }
          EOF
          )

          # Update Firebase Realtime Database
          curl -X PUT \
            "https://t4bf-docs-default-rtdb.firebaseio.com/documentation/htmlCache.json?auth=${{ secrets.FIREBASE_DATABASE_SECRET }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"

          echo "Firebase cache updated successfully"

      - name: Generate stripped export version
        run: |
          # Extract just the main content
          MAIN_CONTENT=$(sed -n '/<main[^>]*>/,/<\/main>/p' documentation.html)

          # Create a clean, stripped HTML file
          cat > documentation-export.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>T4BF MPX Documentation</title>
              <style>
                  body {
                      font-family: Georgia, serif;
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 20px;
                      line-height: 1.6;
                  }
                  code, pre {
                      font-family: monospace;
                      background: #f4f4f4;
                  }
                  pre {
                      padding: 10px;
                      border: 1px solid #ddd;
                      overflow-x: auto;
                  }
                  table {
                      border-collapse: collapse;
                      margin: 1em 0;
                      width: 100%;
                  }
                  th, td {
                      border: 1px solid #000;
                      padding: 8px 12px;
                      text-align: left;
                  }
                  th {
                      background: #f0f0f0;
                  }
                  h1, h2, h3 {
                      margin-top: 1.5em;
                  }
              </style>
          </head>
          <body>
          HTMLEOF

          # Append the main content
          echo "$MAIN_CONTENT" >> documentation-export.html

          # Close the HTML
          cat >> documentation-export.html << 'HTMLEOF'
          </body>
          </html>
          HTMLEOF

          echo "Generated documentation-export.html"

      - name: Commit and push export file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add documentation-export.html
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-generate stripped documentation export"
            git push
          fi
